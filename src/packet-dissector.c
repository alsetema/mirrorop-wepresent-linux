#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "awindib-protocol.h"

char *pkt1 = "4157494e4449422007000000271000000000077f04370000011800000cce000001180000011856534d4b0132419a00000001093000000106010305602080000001419ac02a8033a7e01593f01ca15ffffc0086ca6f48780c47e018f8987501c0004004001002c51320180d0000f8006990091227c67fceafde32f4fe0156e6b46935e44884884266310c43061840120ca080128ef14000b90035af71fff700044677a5bd0d302800182001d8dddebfffd600228ae5d373e0f130ba0380008110002048aa6601afe0001020000c122a23ebcf0573307f8eb6ad77dff0802531c200483aa5f87efb1c801b19dbc277fdb373767fffecb04198b112e082a90580effed99460513f010e7e009d78b5ef492c0be77cfc5727475081f8022f3f00821f6c0789f80130cfe7f3f0047a7e0044d3f01f27ecfc008a6231b680231f1460b0f874530050c000000057800001000100000000000000000000000000000000000000000000000000000049425441494c";
char *pkt2 = "4157494e4449422007000000271000000000077f04370000019f00000d550000019f0000019f56534d4b0132419a00000001093000000106010305402080000001419a80268033a7e01593f00a39f8063e110503501c000e800802ce26000ea0ccb7c204089db63cd80c0003a00698012683c0000084b41380e00066800080c000e4c00347308fd86c038449b0067e6b8e4e200006a8018041aa70782ac6230cd10b38a286ed07f0800800c600c08000880073c03c013030053a4f0b800ae6df0207e159aab40d04870e433fdadc14a2485919ff00250d0082e0c16800a5f224e28ac91e596a86e464a22de8fb5df16f33d86aefe16701934d7ad3c1f000020460ec004ddb0aaeba13ba4317829717c6868082406bc132554f8a60058ac163dbc00300535034452fb765c619d5954990733bffff5bc3de354a53ede0770e2800213b338ac6fe6ad4c6b3c002c20e0b838bdc797be2799a3f60141031c3893091624b2879a509787f616bfc7f87f8978000100da00386ae3244e1e8efa3e53b7bb07a010c2ca2b1c9457735f9cfef7f800c07092655b4556d947175106030e0513f010e7e009d4f96205f3be7e1a3f0045e7e01043ed80f13f002619fcfe7e008f4fc0089a7e03e4fd9f80159a000000055800001000100000000000000000000000000000000000000000000000000000049425441494c";
char *pkt3 = "4157494e4449422007000000271000000000077f0437000001f600000dac000001f6000001f656534d4b0132419a00000001093000000106010305002080000001419a00268033a7e01593f00a39f8045e06502c8d400336dbe29b880001b80060126a9c80001b003400934787800084b41c000e800802ce4b038001d0010059c962c000425a5800084b41c000e800802ce2616000212d070003a00200b38985800084b4500010968a000212d14000425a000990415774831c497ec2000040c0202001409000582010006038000e8011e268502241267e160004c00040174b00026000200b0c0080865a603a81873e160005000040334b0002800020190e60f3870fc770876d7d5cce03700028034c873c3efe3e1002000602a0100400040140f883800130001007d0028341a10e512abd20021845c07000280002019a004ebc2739883fabd20004146dc03b981e198600071fe10edaf5b3202c000a5b4060e8bc1cfc0100040c0914eebc7a48ad0ea83992824af780839421f61330640d2969fa9025163c000100800813caf308239b2f69caa100800401100808003804cc1c00098000803c20068241c39044fda1e010c22140380014000100c8400ce119298e3a3768800105172e67f801194b087049fdaf04bebeb0fe170804c438404e5343804308b81c021844be1c004146dc0e0020a365d301927e021cfc013a9f2c40be77cfc347e008bcfc02087db01e27e004c33f9fcfc011e9f801134fc07c9fb3f002b34000000051800001000100000000000000000000000000000000000000000000000000000049425441494c";

/**
 * Parse a hex stream to binary, returns malloc'd pointer that MUST be freed by the caller (bad design)
 * WILL break/do funky stuff if non-hex characters are present
 * @param size the size of the hex stream
 * @param hex the hex stream
 * @return an malloc'd pointer containing the binary form of the hex stream
 */
uint8_t *hex_to_bin(unsigned int *size, char *hex) {
    unsigned int length = strlen(hex) / 2;
    *size = length;
    uint8_t *values = malloc(length);
    char *pos = hex;
    for (size_t count = 0; count < length; count++) {
        sscanf(pos, "%2hhx", &values[count]);
        pos += 2;
    }
    return values;
}

void print_array(uint8_t *values, unsigned int count) {
    printf("const uint8_t *array = ");
    for (int i = 0; i < count; i++) {
        if (i == 0) {
            printf("{");
        }
        printf("0x%02X", values[i]);
        if (i == (count - 1)) {
            printf("}");
        } else {
            printf(", ");
        }
        if ((i + 1) % 16 == 0) {
            printf("\n                        ");
        }
    }
    printf("\n");
}

int main(int argc, char *argv[]) {
    unsigned int length;
    uint8_t *pkt_bin = hex_to_bin(&length, pkt3);
    uint32_t frame_length;
    awindib_get_framenum(pkt_bin, length, &frame_length);
    printf("%d\n", frame_length);

    unsigned int data_length;
    awindib_get_length(pkt_bin, length, &data_length);
    printf("%d\n", data_length);
}