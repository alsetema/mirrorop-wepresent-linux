#include <stdint.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "awindib-protocol.h"

//                                         Data ln         Data ln Data ln
// A W I N D I Bv1v2v3v4                   b1b2b3b4        b1b2b3b4b1b2b3b4 V S M K . 2 A _
// <non-header data?>
// Frame num
//b1b2b3b4__cnstcnst<27 0x00 bytes>IBTAIL (cnst = constant = 0x0100)
char *pkt1 = "4157494e4449422007000000271000000000077f04370000005500000c0b000000550000005556534d4b0132419a"
             "00000001093000000106010305202080000001419a40268033a7e01593f00a39f80208edc640bb0289f80873f004ea7cb102f9df3f0d1f8022f3f00821f6c0789f80130cfe7f3f0047a7e0044d3f01f27ecfc00acd"
             "00000053800001000100000000000000000000000000000000000000000000000000000049425441494c";
char *pkt2 = "4157494e4449422007000000271000000000077f04370000014b00000d010000014b0000014b56534d4b0132419a"
             "00000001093000000106010305302080000001419a60268033a7e01593f00a39f8063e24407d01c000d800802cd266110001d0034809346bb004e8c8d88b985e5a900156e6b4693940003568018041ab383c034004479670efadff83c000e0008028e4b74584123020402728140145803447e1c0843de845e01014f868cbafb3ee9bcc85cff002b4004aac81c02af2ba6334037b2c4e54fb5b8a64a88c78f2bc0264b26f6f03bc48818e03800082080008080101b960700010410001010070765b001c83fdb8c35e8c6ac8410ff1807a0816fb969ed0638eb258032c018a03140600034f23a4280cf01cc211280a000202c0e701d01a7ee32a160d6a130a5c1f80ce0205b92b49b592c4d2da61f800403041228e20b38c219c2a9b21870289f80873f004ea7cb102f9df3f0d1f8022f3f00821f6c0789f80130cfe7f3f0047a7e0044d3f01f27ecfc00acd"
             "00000054800001000100000000000000000000000000000000000000000000000000000049425441494c";
char *pkt3 = "4157494e4449422007000000271000000000077f04370000019f00000d550000019f0000019f56534d4b0132419a"
             "00000001093000000106010305402080000001419a80268033a7e01593f00a39f8063e110503501c000e800802ce26000ea0ccb7c204089db63cd80c0003a00698012683c0000084b41380e00066800080c000e4c00347308fd86c038449b0067e6b8e4e200006a8018041aa70782ac6230cd10b38a286ed07f0800800c600c08000880073c03c013030053a4f0b800ae6df0207e159aab40d04870e433fdadc14a2485919ff00250d0082e0c16800a5f224e28ac91e596a86e464a22de8fb5df16f33d86aefe16701934d7ad3c1f000020460ec004ddb0aaeba13ba4317829717c6868082406bc132554f8a60058ac163dbc00300535034452fb765c619d5954990733bffff5bc3de354a53ede0770e2800213b338ac6fe6ad4c6b3c002c20e0b838bdc797be2799a3f60141031c3893091624b2879a509787f616bfc7f87f8978000100da00386ae3244e1e8efa3e53b7bb07a010c2ca2b1c9457735f9cfef7f800c07092655b4556d947175106030e0513f010e7e009d4f96205f3be7e1a3f0045e7e01043ed80f13f002619fcfe7e008f4fc0089a7e03e4fd9f80159a0"
             "00000055800001000100000000000000000000000000000000000000000000000000000049425441494c";
char *pkt4 = "4157494e4449422007000000271000000000077f04370000007500000c2b000000750000007556534d4b0132419a"
             "00000001093000000106010303d02080000001419ba02a8033a7e01593f01ca15ffffc0086ca6f48780c47e00964fc0439f802d43be7e02620802103c410041a821f193e2303bc301080c13f00821f6c0789f80130cfe7f3f0047a7e0044d3f01f27ecfc008a6231b680231f1460b0f874530050c"
             "00000003e800001000100000000000000000000000000000000000000000000000000000049425441494c";
char *pkt5 = "4157494e4449422007000000271000000000077f04370003f4ca000400800003f4ca0003f4ca56534d4b0132419a"
             "0000000109100000000167640028acb403c0113f2c2000000300200000079c4c0002625a0001312d498400f1832a0000000168ce0fcb00000106000593c6804651800000010605ffff9bdc45e9bde6d948b7962cd820d923eeef78323634202d20636f726520313432202d20482e3236342f4d5045472d342041564320636f646563202d20436f70796c65667420323030332d32303134202d20687474703a2f2f7777772e766964656f6c616e2e6f72672f783236342e68746d6c202d206f7074696f6e733a2063616261633d30207265663d31206465626c6f636b3d303a303a3020616e616c7973653d3078333a307833206d653d646961207375626d653d31207073793d31207073795f72643d312e30303a302e3030206d697865645f7265663d30206d655f72616e67653d3136206368726f6d615f6d653d31207472656c6c69733d30203878386463743d312063716d3d3020646561647a6f6e653d32312c313120666173745f70736b69703d31206368726f6d615f71705f6f66667365743d3020746872656164733d31206c6f6f6b61686561645f746872656164733d3120736c696365645f746872656164733d30206e723d3020646563696d6174653d3120696e7465726c616365643d3020626c757261795f636f6d7061743d3120636f6e73747261696e65645f696e7472613d3020626672616d65733d3020776569676874703d30206b6579696e743d323030206b6579696e745f6d696e3d31207363656e656375743d343020696e7472615f726566726573683d302072635f6c6f6f6b61686561643d302072633d637266206d62747265653d30206372663d32332e332071636f6d703d302e36302071706d696e3d31302071706d61783d3639207170737465703d34207662765f6d6178726174653d3130303030207662765f62756673697a653d3130303030206372665f6d61783d302e30206e616c5f6872643d7662722066696c6c65723d302069705f726174696f3d312e34302061713d300080000001060103000020800000016588843abfffe1e8a000206df7ffeef0af87679b8276b9732effab81d5e158256a47a27fffc83deb820ee343213fc21fabffc185f81463c79412f02dd74fcbc9d820599c2b6b801d7a780b6b8440371bf41da5542c539c283df713bdc045eee041454be34affdd150410770014af86f8308327bff20985d2558d6a3fffce022f5de87ec9e7526686a83a901c58b5202932746c51c080202ac604084e2700656ec44a50a7f0d01f380575a7600625a37204ba8561d740cfb2f5085ebeec5a5448ad85c06837938425a32fe1fabffc185f8fa30b2ec4dc365254c10911807e047199a737032dd2f04410abe9e6e08bfb9f4bfe792ced4c045eea728a0a97e5dbff9baa020ee0043d30e90853f6941732a6dcb50320059719c0e2e408f1c7a2232eef5d160f421fb07bcc96c2d29d14890200028073450400084713818e899e781bd9941ce03f36c23c6c00d3887495837b6f5a085fb5e6b01aa62b0364978e869ca773825fe25a32e4b5b0972fbae25b2c9c31ffff8043f472ff60949807e04423469cdc24736f5143ebc017fdceb309ed7c194c92e994970b765465c5f7d0c252f6990a32eff0f54141def0014af86f830a3a7bff008bd77a0fd99606c5d25f1ae3fffd44070b16a4100016053cc0800119cff0029ec32281db35e004dce1390652b57fa4170c16dd499a1aa0eaf0293274661670a29e981ba610000e00a840003a022ef34ff674f88e54ff0f57fc21fdf2727fe1eaf261df5fff83c175e001f64738dc40102b7d02c504bcaddcb25fdd32ff4eff1b951c50770018e45181a98c57c026827da6ae222fbf6a07dbc4d9f47fea013393827c4270f77f00c5eab7d607b3d1095cc409040fe0808749410086417801069e44cc3a0882ce56006dbb6003376a33882810ca2df0027ddbd30495b936ba6010";
// No trailer! (too larger for packet)
char *pkt6 = "4157494e4449422007000000271000000000077f04370003c8180003d3ce0003c8180003c81856534d4b0132419a"
             "0000000109100000000167640028acb403c0113f2c2000000300200000079c4c0002625a0001312d498400f1832a0000000168ce0fcb00000106000593c6804651800000010605ffff9bdc45e9bde6d948b7962cd820d923eeef78323634202d20636f726520313432202d20482e3236342f4d5045472d342041564320636f646563202d20436f70796c65667420323030332d32303134202d20687474703a2f2f7777772e766964656f6c616e2e6f72672f783236342e68746d6c202d206f7074696f6e733a2063616261633d30207265663d31206465626c6f636b3d303a303a3020616e616c7973653d3078333a307833206d653d646961207375626d653d31207073793d31207073795f72643d312e30303a302e3030206d697865645f7265663d30206d655f72616e67653d3136206368726f6d615f6d653d31207472656c6c69733d30203878386463743d312063716d3d3020646561647a6f6e653d32312c313120666173745f70736b69703d31206368726f6d615f71705f6f66667365743d3020746872656164733d31206c6f6f6b61686561645f746872656164733d3120736c696365645f746872656164733d30206e723d3020646563696d6174653d3120696e7465726c616365643d3020626c757261795f636f6d7061743d3120636f6e73747261696e65645f696e7472613d3020626672616d65733d3020776569676874703d30206b6579696e743d323030206b6579696e745f6d696e3d31207363656e656375743d343020696e7472615f726566726573683d302072635f6c6f6f6b61686561643d302072633d637266206d62747265653d30206372663d32332e332071636f6d703d302e36302071706d696e3d31302071706d61783d3639207170737465703d34207662765f6d6178726174653d3130303030207662765f62756673697a653d3130303030206372665f6d61783d302e30206e616c5f6872643d7662722066696c6c65723d302069705f726174696f3d312e34302061713d300080000001060103000020800000016588843abfffe1e8a000206df7ffeef0af87679b8276b9732effab81d5e158256a47a27fffc83deb820ee343213fc21fabffc185f81463c79412f02dd74fcbc9d820599c2b6b801d7a780b6b8440371bf41da5542c539c283df713bdc045eee041454be34affdd150410770014af8c78308327bff2098be95635a8ffff30117aef43f64f3a93343541d480e163d480a4c9d1b147020080ab181021389c0195bb1129429fc3407ce015d69d8018968dc809750ac3ae819f65ea10bd7dd8b4a8915b0b80d06f27084b465fc3f57ff830bf1f46165d89b86ca4a982122300fc08e3334e6e065ba5e0882157d3cdc117f73e97fcf259da9808bdd4e514152fcbb7ff3754041dc0087a61d210a7ed282e654db96a06400b2e3381474811e38f44464deeba6c159887a83acc96c2d29d148d0200028073450400084713818e899e781bd9941ce03f36c23c6c00d3887495837b6f5a085fc3b4c06e262b0364978e434e53b9c12ff12d19725ad84b97dd712d964e18ffffc021fa397fb04a4c03f02211a34e6e1239b7a8a1f5e00bfee75984f6be0ca64974ca4b85bb2a32e2fbe861297b4c851977f87aa0a0ef7800a57c37c1851d3dff8045ebbd07ecde06c5d25f1ae3fffd44070b16a4100016053cc0800119cff0029ec32281db35e004ddc22b0ca56aff482e182dba93343541d5e05264e8cc2ce1453d30374c20001c0150800074045de69fece9f11ca9fe1eaff843fbe4e4ffc3d5e4c3bebfff0782ebc002eb238e3710040bfe8162825e56de592fee997fa77f8dca8e283b800c7228c0d4c62be013413ed35711539fb503ede26cfa3ff50099c9c13e21387bbf8062f55beb03d9e884ae62048207f04043a4a0804320bc00834f22661d0441672b0036ddb0019bb519c414086516f8013eede9824adc9b5d3008";
// No trailer! (too large for packet)
char *pkt7 = "777070636d6400008107800438203536350780043818a918011c160100000000000000000000000000000000000064000000020407000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

/**
 * Parse a hex stream to binary, returns malloc'd pointer that MUST be freed by the caller (bad design)
 * WILL break/do funky stuff if non-hex characters are present
 * @param size the size of the hex stream
 * @param hex the hex stream
 * @return an malloc'd pointer containing the binary form of the hex stream
 */
uint8_t *hex_to_bin(unsigned int *size, char *hex) {
    unsigned int length = strlen(hex) / 2;
    *size = length;
    uint8_t *values = malloc(length);
    char *pos = hex;
    for (size_t count = 0; count < length; count++) {
        sscanf(pos, "%2hhx", &values[count]);
        pos += 2;
    }
    return values;
}

void print_array(uint8_t *values, unsigned int count) {
    printf("const uint8_t *info_response = ");
    for (int i = 0; i < count; i++) {
        if (i == 0) {
            printf("{");
        }
        printf("0x%02X", values[i]);
        if (i == (count - 1)) {
            printf("}");
        } else {
            printf(", ");
        }
        if ((i + 1) % 16 == 0) {
            printf("\n                        ");
        }
    }
    printf("\n");
}

int main(int argc, char *argv[]) {
    unsigned int length;
    uint8_t *pkt_bin = hex_to_bin(&length, pkt7);
    print_array(pkt_bin, length);
    uint32_t frame_length;
    awindib_get_framenum(pkt_bin, length, &frame_length);
    printf("%d\n", frame_length);

    unsigned int data_length;
    awindib_get_length(pkt_bin, length, &data_length);
    printf("%d\n", data_length);
}